**(작성중..)**

### Reference
- https://kubetm.github.io/k8s/92-installation/case4/
- https://github.com/kubernetes/dashboard/blob/master/docs/user/installation.md
- https://kubernetes.io/ko/docs/tasks/access-application-cluster/web-ui-dashboard/
- https://github.com/kubernetes/dashboard
- Creating sample user : https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md
- 쿠버네티스 클러스터 구축 - MetalLB 설치 : https://cla9.tistory.com/94
- https://metallb.universe.tf/installation/
- https://yunhochung.medium.com/k8s-%EB%8C%80%EC%89%AC%EB%B3%B4%EB%93%9C-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%99%B8%EB%B6%80-%EC%A0%91%EC%86%8D-%EA%B8%B0%EB%8A%A5-%EC%B6%94%EA%B0%80%ED%95%98%EA%B8%B0-22ed1cd0999f
----
## Part3 : 
### 주의점!!!
- Kubernetes는 기본적으로 HTTPS로 접속 권장(Recommended)
- 본 문서에서는 kubectl proxy가 아닌 MetalLB를 사용하여 LoadBalancer를 통해 접속하는 방법 사용
----
### MetalLB 설치
MetalLB 배포
```bash
$ kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.10.2/manifests/namespace.yaml
namespace/metallb-system created
$ kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.10.2/manifests/metallb.yaml
Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
podsecuritypolicy.policy/controller created
podsecuritypolicy.policy/speaker created
serviceaccount/controller created
serviceaccount/speaker created
clusterrole.rbac.authorization.k8s.io/metallb-system:controller created
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created
role.rbac.authorization.k8s.io/config-watcher created
role.rbac.authorization.k8s.io/pod-lister created
role.rbac.authorization.k8s.io/controller created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created
rolebinding.rbac.authorization.k8s.io/config-watcher created
rolebinding.rbac.authorization.k8s.io/pod-lister created
rolebinding.rbac.authorization.k8s.io/controller created
daemonset.apps/speaker created
deployment.apps/controller created
```
addresses의 주소는 개별 네트웍 설정에 맞추어 수정 필요
```bash
[vagrant@kubemaster1 ~]$ vi layer2-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.56.250-192.168.56.255
[vagrant@kubemaster1 ~]$ kubectl apply -f layer2-config.yaml
configmap/config created
```
### Dashboard에서 사용할 Key, Cert 생성
개인키, CSR(Certificate Signing Request) 생성하기
```
$ mkdir certs; cd certs
$ openssl genrsa -des3 -passout pass:x -out dashboard.pass.key 2048
Generating RSA private key, 2048 bit long modulus
.....................................................................+++
............+++
e is 65537 (0x10001)
$ openssl rsa -passin pass:x -in dashboard.pass.key -out dashboard.key
writing RSA key
$ rm dashboard.pass.key
$ openssl req -new -key dashboard.key -out dashboard.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:KR
State or Province Name (full name) []:
Locality Name (eg, city) [Default City]:Seoul
Organization Name (eg, company) [Default Company Ltd]:NK
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server's hostname) []:dashboard.k8s.local
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```
SSL Certificate 생성하기
```$ openssl x509 -req -sha256 -days 365 -in dashboard.csr -signkey dashboard.key -out dashboard.crt
Signature ok
subject=/C=KR/L=Seoul/O=NK/CN=dashboard.k8s.local
```
Secret 만들기
```
$ ls
dashboard.crt  dashboard.csr  dashboard.key
$ cd ..
$ kubectl create secret generic kubernetes-dashboard-certs --from-file=./certs -n kube-system
secret/kubernetes-dashboard-certs created
```
Sercret 생성 확인
```
kubectl get secrets -n kube-system | grep dashboard
kubernetes-dashboard-certs                       Opaque                                3      3m42s
```


### kubernetes-dashboard 설치
manifest 파일 다운로드
```
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
```
Service Type을 Loadbalancer로 변경
* **type: LoadBalancer** 문구 추가
```bash
$ vi recommended.yaml
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: LoadBalancer
  ports:
    - port: 443
      targetPort: 8443
  selector:
    k8s-app: kubernetes-dashboard
```

```bash
nohup kubectl proxy --port=8001 --address=192.168.0.231 --accept-hosts='^*$' >/dev/null 2>&1 &
```

Web UI 접속
* http://192.168.0.231:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/


### 기타 참고
kubernetes-dashboard 삭제
```
$ kubectl delete -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
namespace "kubernetes-dashboard" deleted
serviceaccount "kubernetes-dashboard" deleted
service "kubernetes-dashboard" deleted
secret "kubernetes-dashboard-certs" deleted
secret "kubernetes-dashboard-csrf" deleted
secret "kubernetes-dashboard-key-holder" deleted
configmap "kubernetes-dashboard-settings" deleted
role.rbac.authorization.k8s.io "kubernetes-dashboard" deleted
clusterrole.rbac.authorization.k8s.io "kubernetes-dashboard" deleted
rolebinding.rbac.authorization.k8s.io "kubernetes-dashboard" deleted
clusterrolebinding.rbac.authorization.k8s.io "kubernetes-dashboard" deleted
deployment.apps "kubernetes-dashboard" deleted
service "dashboard-metrics-scraper" deleted
deployment.apps "dashboard-metrics-scraper" deleted

$ kubectl get deployments --all-namespaces
NAMESPACE     NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   calico-kube-controllers   1/1     1            1           64m
kube-system   coredns                   2/2     2            2           68m

```
